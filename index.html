<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSX Stock Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom scrollbar for a sleeker look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 10px;
            border: 2px solid #1f2937;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #6b7280;
        }
        /* Style for the searchable dropdown */
        .search-dropdown-content {
            display: none;
            position: absolute;
            background-color: #1f2937;
            border: 1px solid #4b5563;
            min-width: 280px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 10;
        }
        .search-dropdown-content a {
            color: #d1d5db;
            padding: 10px 14px;
            text-decoration: none;
            display: block;
        }
        .search-dropdown-content a:hover {
            background-color: #374151;
        }
        /* Chart.js tooltip customization */
        .chartjs-tooltip {
            background: rgba(31, 41, 55, 0.8);
            border-radius: 0.375rem;
            color: white;
            padding: 0.5rem;
            pointer-events: none;
            transition: all .1s ease;
            backdrop-filter: blur(4px);
        }
        .loader {
          border: 4px solid #374151;
          border-left-color: #3b82f6;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300 font-sans antialiased">
    <div id="app" class="flex flex-col md:flex-row h-screen">

        <!-- Sidebar -->
        <aside class="w-full md:w-64 bg-gray-800 p-4 md:p-6 flex-shrink-0">
            <div class="flex items-center mb-8">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500 h-8 w-8 mr-3"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                <h1 class="text-2xl font-bold text-white">PSX Analytics</h1>
            </div>

            <!-- Searchable Dropdown -->
            <div class="relative mb-6" id="search-container">
                <input type="text" id="searchInput" onkeyup="filterFunction()" placeholder="Search for company..." class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div id="searchDropdown" class="search-dropdown-content mt-1 rounded-md shadow-lg">
                    <!-- Tickers will be populated here by JS -->
                </div>
            </div>

            <nav id="navigation" class="space-y-2">
                <!-- Navigation items will be populated by JS -->
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8">
            <div id="main-content-area">
                <!-- Welcome Message -->
                <div id="welcome-view" class="h-full flex flex-col items-center justify-center text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-20 w-20 text-gray-600 mb-4"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
                    <h2 class="text-3xl font-bold text-white mb-2">Welcome to PSX Analytics</h2>
                    <p class="text-gray-400 max-w-md">Please search for a company symbol (e.g., OGDC, UBL, SYS) to begin your analysis.</p>
                </div>

                <!-- Loader -->
                <div id="loader-view" class="hidden h-full flex flex-col items-center justify-center">
                    <div class="loader"></div>
                    <p class="mt-4 text-gray-400">Fetching data from PSX...</p>
                </div>
                
                <!-- Data Views -->
                <div id="data-views-container" class="hidden">
                    <!-- Content for different tabs will be rendered here -->
                </div>
            </div>
        </main>
    </div>

<script>
    // --- CONSTANTS & STATE ---
    const SYMBOLS = {
        "786": "786 Investments Limited", "AABS": "Al-Abbas Sugar Mills Limited", "AATM": "Ali Asghar Textile Mills Limited", "ABL": "Allied Bank Limited", "ABOT": "Abbott Laboratories (Pakistan) Limited",
        "ACIETF": "Alfalah Consumer Index (ETF)", "ACPL": "Attock Cement Pakistan Limited", "ADAMS": "Adam Sugar Mills Limited", "ADMM": "Artistic Denim Mills Limited", "AGHA": "Agha Steel Ind.Ltd",
        "AGIC": "Askari General Insurance Company Limited", "AGIL": "Agriauto Industries Limited", "AGL": "Agritech Limited", "AGP": "AGP Limited", "AGTL": "Al-Ghazi Tractors Limited",
        "AHCL": "Arif Habib Corporation Limited", "AHL": "Arif Habib Limited", "AICL": "Adamjee Insurance Company Limited", "AIRLINK": "Air Link Communication Limited", "AKBL": "Askari Bank Limited",
        "ALAC": "Askari Life Assurance Company Limited", "ALIFE": "Adamjee Life Assurance Company Limited", "ALTN": "Altern Energy Limited", "AMBL": "Apna Microfinance Bank Limited", "ANL": "Azgard Nine Limited",
        "APL": "Attock Petroleum Limited", "ARPL": "Archroma Pakistan Limited", "ASL": "Aisha Steel Mills Limited", "ASTL": "Amreli Steels Limited", "ATBA": "Atlas Battery Limited",
        "ATIL": "Atlas Insurance Limited", "ATLH": "Atlas Honda Limited", "ATRL": "Attock Refinery Limited", "AVN": "Avanceon Limited", "BAFL": "Bank Alfalah Limited", "BAHL": "Bank AL Habib Limited",
        "BATA": "Bata Pakistan Limited", "BBFL": "Big Bird Foods Limited", "BCL": "Bolan Castings Limited", "BERG": "Berger Paints Pakistan Limited", "BGL": "Baluchistan Glass Limited",
        "BIFO": "Biafo Industries Limited", "BIPL": "BankIslami Pakistan Limited", "BML": "Bank Makramah Limited", "BNL": "Bunnys Limited", "BOK": "The Bank of Khyber", "BOP": "The Bank of Punjab",
        "BWCL": "Bestway Cement Limited", "BWHL": "Baluchistan Wheels Limited", "CEPB": "Century Paper & Board Mills Limited", "CHCC": "Cherat Cement Company Limited", "CLOV": "Clover Pakistan Limited",
        "CNERGY": "Cnergyico PK Limited", "COLG": "Colgate-Palmolive (Pakistan) Limited", "CPHL": "Citi Pharma Ltd.", "CPPL": "Cherat Packaging Limited", "CSAP": "Crescent Steel & Allied Products Limited",
        "CYAN": "Cyan Limited", "DADX": "Dadex Eternit Limited", "DCL": "Dewan Cement Limited", "DCR": "Dolmen City REIT", "DFML": "Dewan Farooque Motors Limited", "DGKC": "D.G. Khan Cement Company Limited",
        "DLL": "Dawood Lawrencepur Limited", "DOL": "Descon Oxychem Limited", "DYNO": "Dynea Pakistan Limited", "ECOP": "Ecopack Limited", "EFERT": "Engro Fertilizers Limited", "EFUG": "EFU General Insurance Limited",
        "EFUL": "EFU Life Assurance Limited", "ENGROH": "Engro Holdings Limited", "EPCL": "Engro Polymer & Chemicals Limited", "EPQL": "Engro Powergen Qadirpur Limited", "EXIDE": "Exide Pakistan Limited",
        "FABL": "Faysal Bank Limited", "FATIMA": "Fatima Fertilizer Company Limited", "FCCL": "Fauji Cement Company Limited", "FCEPL": "Frieslandcampina Engro Pakistan Limited", "FCL": "Fast Cables Limited",
        "FECTC": "Fecto Cement Limited", "FEROZ": "Ferozsons Laboratories Limited", "FFC": "Fauji Fertilizer Company Limited", "FFL": "Fauji Foods Limited", "FLYNG": "Flying Cement Company Limited",
        "FML": "Feroze1888 Mills Limited", "GADT": "Gadoon Textile Mills Limited", "GAL": "Ghandhara Automobiles Limited", "GATI": "Gatron (Industries) Limited", "GATM": "Gul Ahmed Textile Mills Limited",
        "GCIL": "Ghani Chemical Industries Limited", "GGGL": "Ghani Global Glass Limited", "GGL": "Ghani Global Holdings Limited", "GHGL": "Ghani Glass Limited", "GHNI": "Ghandhara Industries Limited",
        "GLAXO": "GlaxoSmithKline Pakistan Limited", "GTYR": "Ghandhara Tyre & Rubber Company Limited", "GVGL": "Ghani Value Glass Limited", "GWLC": "Gharibwal Cement Limited", "HABSM": "Habib Sugar Mills Limited",
        "HALEON": "Haleon Pakistan Limited", "HBL": "Habib Bank Limited", "HCAR": "Honda Atlas Cars (Pakistan) Limited", "HINO": "Hinopak Motors Limited", "HINOON": "Highnoon Laboratories Limited",
        "HMB": "Habib Metropolitan Bank Limited", "HPL": "Hoechst Pakistan Limited", "HTL": "Hi-Tech Lubricants Limited", "HUBC": "The Hub Power Company Limited", "HUMNL": "Hum Network Limited",
        "IBFL": "Ibrahim Fibres Limited", "IBLHL": "IBL HealthCare Limited", "ICL": "Ittehad Chemicals Limted", "IDYM": "Indus Dyeing & Manufacturing Co. Limited", "IGIHL": "IGI Holdings Limited",
        "ILP": "Interloop Limited", "INDU": "Indus Motor Company Limited", "INIL": "International Industries Limited", "IPAK": "International Packaging Films Limited", "ISIL": "Ismail Industries Limited",
        "ISL": "International Steels Limited", "ITTEFAQ": "Ittefaq Iron Industries Limited", "JDWS": "JDW Sugar Mills Limited", "JGICL": "Jubilee General Insurance Limited", "JLICL": "Jubilee Life Insurance Company Limited",
        "JSBL": "JS Bank Limited", "JSCL": "Jahangir Siddiqui & Co. Ltd.", "JVDC": "Javedan Corporation Limited", "KAPCO": "Kot Addu Power Company Limited", "KCL": "Karam Ceramics Limited",
        "KEL": "K-Electric Limited", "KOHC": "Kohat Cement Company Limited", "KTML": "Kohinoor Textile Mills Limited", "LCI": "Lucky Core Industries Limited", "LOADS": "Loads Limited",
        "LOTCHEM": "Lotte Chemical Pakistan Limited", "LPL": "Lalpir Power Limited", "LUCK": "Lucky Cement Limited", "MACFL": "MACPAC Films Limited", "MACTER": "Macter International Limited",
        "MARI": "Mari Energies Limited", "MCB": "MCB Bank Limited", "MEBL": "Meezan Bank Limited", "MFFL": "Mitchells Fruit Farms Limited", "MFL": "Matco Foods Limited",
        "MLCF": "Maple Leaf Cement Factory Limited", "MTL": "Millat Tractors Limited", "MUGHAL": "Mughal Iron & Steel Industries Limited", "MUREB": "Murree Brewery Company Limited", "NATF": "National Foods Limited",
        "NBP": "National Bank of Pakistan", "NCL": "Nishat Chunian Limited", "NCPL": "Nishat Chunian Power Limited", "NESTLE": "Nestle Pakistan Limited", "NETSOL": "NetSol Technologies Limited",
        "NICL": "Nimir Industrial Chemicals Limited", "NML": "Nishat Mills Limited", "NPL": "Nishat Power Limited", "NRL": "National Refinery Limited", "NRSL": "Nimir Resins Limited",
        "OCTOPUS": "Octopus Digital Limited", "OGDC": "Oil & Gas Development Company Limited", "OLPL": "OLP Financial Services Pakistan Limited", "OTSU": "Otsuka Pakistan Limited", "PABC": "Pakistan Aluminium Beverage Cans Limited",
        "PACE": "Pace (Pakistan) Limited", "PAEL": "Pak Elektron Limited", "PAKD": "Pak Datacom Limited", "PAKOXY": "Pakistan Oxygen Limited", "PAKRI": "Pakistan Reinsurance Company Limited",
        "PAKT": "Pakistan Tobacco Company Limited", "PCAL": "Pakistan Cables Limited", "PIBTL": "Pakistan International Bulk Terminal", "PICT": "Pakistan International Container", "PIOC": "Pioneer Cement Limited",
        "PKGP": "Pakgen Power Limited", "PKGS": "Packages Limited", "PMPK": "Philip Morris (Pakistan) Limited", "PNSC": "Pakistan National Shipping Corporation", "POL": "Pakistan Oilfields Limited",
        "POWER": "Power Cement Limited", "PPL": "Pakistan Petroleum Limited", "PREMA": "At-Tahur Limited", "PRL": "Pakistan Refinery Limited", "PSEL": "Pakistan Services Limited",
        "PSO": "Pakistan State Oil Company Limited", "PSX": "Pakistan Stock Exchange Limited", "PTC": "Pakistan Telecommunication Company Ltd", "PTL": "Panther Tyres Ltd.", "RCML": "Reliance Cotton Spinning Mills Limited",
        "RMPL": "Rafhan Maize Products Company Limited", "RUPL": "Rupali Polyester Limited", "SAZEW": "Sazgar Engineering Works Limited", "SBL": "Samba Bank Limited", "SCBPL": "Standard Chartered Bank (Pak) Ltd",
        "SCL": "Shield Corporation Limited", "SEARL": "The Searle Company Limited", "SEPL": "Security Papers Limited", "SFL": "Sapphire Fibres Limited", "SGF": "Service GlobalFootwear Limited",
        "SHFA": "Shifa International Hospitals Limited", "SIEM": "Siemens (Pakistan) Engineering", "SITC": "Sitara Chemical Industries Limited", "SNGP": "Sui Northern Gas Pipelines Limited", "SPEL": "SPEL Limited",
        "SPWL": "Saif Power Limited", "SRVI": "Service Industries Limited", "SSGC": "Sui Southern Gas Company Limited", "SSOM": "S.S.Oil Mills Limited", "STCL": "Shabbir Tiles & Ceramics Limited",
        "SYS": "Systems Limited", "TATM": "Tata Textile Mills Limited", "TBL": "Treet Battery Limited.", "TELE": "Telecard Limited", "TGL": "Tariq Glass Industries Limited", "THALL": "Thal Limited",
        "THCCL": "Thatta Cement Company Limited", "TICL": "The Thal Industries Corporation Limited", "TOMCL": "The Organic Meat Company Limited", "TOWL": "Towellers Limited", "TPLP": "TPL Properties Limited",
        "TPLT": "TPL Trakker Limited", "TREET": "Treet Corporation Limited", "TRG": "TRG Pakistan Limited", "TRIPF": "Tri-Pack Films Limited", "TSML": "Tandlianwala Sugar Mills Limited",
        "UBL": "United Bank Limited", "UNIC": "The United Insurance Company", "UNITY": "Unity Foods Limited", "UPFL": "Unilever Pakistan Foods Limited", "WAFI": "Wafi Energy Pakistan Limited",
        "WAHN": "Wah Noble Chemicals Limited", "WAVES": "Waves Corporation Limited", "WTL": "Worldcall Telecom Limited", "ZIL": "ZIL Limited"
    };

    const CORS_PROXY = "https://api.allorigins.win/raw?url=";
    
    const navItems = [
        { id: 'snapshot', name: 'Snapshot', icon: 'AreaChart' },
        { id: 'financials', name: 'Financials', icon: 'BookOpen' },
        { id: 'historical', name: 'Historical Data', icon: 'CalendarClock' },
        { id: 'intraday', name: 'Intraday Data', icon: 'BarChart3' },
        { id: 'announcements', name: 'Announcements', icon: 'Megaphone' },
        { id: 'comparison', name: 'Comparative Analysis', icon: 'GitCompareArrows' }
    ];

    let state = {
        currentSymbol: null,
        activeTab: 'snapshot',
        cachedData: {},
        comparison: {
            tickers: [],
            max: 4,
            data: {}
        }
    };
    
    // --- DOM ELEMENTS ---
    const searchInput = document.getElementById('searchInput');
    const searchDropdown = document.getElementById('searchDropdown');
    const searchContainer = document.getElementById('search-container');
    const navigation = document.getElementById('navigation');
    const mainContent = document.getElementById('main-content-area');
    const welcomeView = document.getElementById('welcome-view');
    const loaderView = document.getElementById('loader-view');
    const dataViewsContainer = document.getElementById('data-views-container');

    // --- HELPER FUNCTIONS ---
    const showView = (viewId) => {
        welcomeView.classList.add('hidden');
        loaderView.classList.add('hidden');
        dataViewsContainer.classList.add('hidden');
        document.getElementById(viewId).classList.remove('hidden');
    };

    const sanitizeText = (text) => text?.replace(/--/g, 'N/A').trim() || 'N/A';

    const formatNumber = (numStr) => {
        const num = parseFloat(numStr?.replace(/,/g, ''));
        if (isNaN(num)) return 'N/A';
        return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };
    
    // --- API & PARSING ---
    
    // Fetches and parses main company page for metadata and financials
    async function fetchCompanyPage(symbol) {
        if (state.cachedData[symbol]?.page) return state.cachedData[symbol].page;
        const url = `${CORS_PROXY}https://dps.psx.com.pk/company/${symbol}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Failed to fetch data for ${symbol}`);
        const htmlText = await response.text();
        const doc = new DOMParser().parseFromString(htmlText, 'text/html');
        
        const data = {
            metadata: parseMetadata(doc),
            financials: parseFinancials(doc)
        };
        
        state.cachedData[symbol] = { ...state.cachedData[symbol], page: data };
        return data;
    }

    // Fetches historical price data
    async function fetchHistoricalData(symbol) {
        if (state.cachedData[symbol]?.historical) return state.cachedData[symbol].historical;
        const url = `${CORS_PROXY}https://dps.psx.com.pk/company/${symbol}/prices`;
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch historical data');
        const text = await response.text();
        try {
            const data = JSON.parse(text);
            state.cachedData[symbol] = { ...state.cachedData[symbol], historical: data };
            return data;
        } catch (e) {
            console.error("Failed to parse JSON for historical data:", text);
            throw new Error(`Received non-JSON response for historical data for ${symbol}.`);
        }
    }
    
    // Fetches intraday price data
    async function fetchIntradayData(symbol) {
        if (state.cachedData[symbol]?.intraday) return state.cachedData[symbol].intraday;
        const url = `${CORS_PROXY}https://dps.psx.com.pk/intraday/quote/${symbol}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch intraday data');
        const text = await response.text();
        try {
            const data = JSON.parse(text);
            state.cachedData[symbol] = { ...state.cachedData[symbol], intraday: data };
            return data;
        } catch (e) {
            console.error("Failed to parse JSON for intraday data:", text);
            throw new Error(`Received non-JSON response for intraday data for ${symbol}.`);
        }
    }
    
    // Fetches company announcements
    async function fetchAnnouncements(symbol) {
        if (state.cachedData[symbol]?.announcements) return state.cachedData[symbol].announcements;
        const url = `${CORS_PROXY}https://dps.psx.com.pk/announcements/companies?symbol=${symbol}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch announcements');
        const htmlText = await response.text();
        const doc = new DOMParser().parseFromString(htmlText, 'text/html');

        const announcements = Array.from(doc.querySelectorAll('#announcementsTable tbody tr')).slice(0, 10).map(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length < 6) return null;
            const pdfLink = cells[5].querySelector('a[href*=".pdf"]');
            return {
                date: sanitizeText(cells[0].textContent),
                time: sanitizeText(cells[1].textContent),
                company: sanitizeText(cells[3].textContent),
                title: sanitizeText(cells[4].textContent),
                link: pdfLink ? `https://dps.psx.com.pk${pdfLink.getAttribute('href')}` : null
            };
        }).filter(Boolean);

        state.cachedData[symbol] = { ...state.cachedData[symbol], announcements };
        return announcements;
    }
    
    // --- PARSING FUNCTIONS (from HTML doc) ---
    function parseMetadata(doc) {
        const getText = (selector) => sanitizeText(doc.querySelector(selector)?.textContent);
        
        const keyPeople = Array.from(doc.querySelectorAll('.profile__item--people tbody tr')).map(row => {
            const cells = row.querySelectorAll('td');
            return { role: sanitizeText(cells[1]?.textContent), name: sanitizeText(cells[0]?.textContent) };
        });

        const profileItems = {};
        doc.querySelectorAll('.profile__item').forEach(item => {
            const head = item.querySelector('.item__head')?.textContent.trim().toLowerCase().replace(/\s+/g, '_');
            const value = item.querySelector('p')?.textContent.trim();
            if (head && value) profileItems[head] = value;
        });
        
        return {
            company_name: getText('.quote__name'),
            sector: getText('.quote__sector span'),
            last_close: getText('.quote__close'),
            change_value: getText('.change__value'),
            change_percent: getText('.change__percent'),
            day_range: getText('.stats_item:nth-child(1) .stats_value'),
            week_range_52: getText('.stats_item:nth-child(2) .stats_value'),
            market_cap: getText('.stats_item:nth-child(3) .stats_value'),
            shares_outstanding: getText('.stats_item:nth-child(4) .stats_value'),
            free_float: getText('.stats_item:nth-child(5) .stats_value'),
            description: getText('.profile__item--description p'),
            key_people: keyPeople,
            profile: profileItems
        };
    }

    function parseFinancials(doc) {
        const parseTable = (tableSelector) => {
            const table = doc.querySelector(tableSelector);
            if (!table) return { headers: [], rows: [] };
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim()).slice(1);
            const rows = Array.from(table.querySelectorAll('tbody tr')).map(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                const label = cells[0]?.textContent.trim();
                const values = cells.slice(1).map(td => sanitizeText(td.textContent));
                return { label, values };
            });
            return { headers, rows };
        };
        
        return {
            ratios: parseTable('.company__ratios table'),
            annual: parseTable('div[data-name="Annual"] table'),
            quarterly: parseTable('div[data-name="Quarterly"] table'),
        };
    }

    // --- UI RENDERING ---
    
    function renderNavigation() {
        navigation.innerHTML = navItems.map(item => `
            <a href="#" id="nav-${item.id}" data-tab="${item.id}" class="nav-item flex items-center p-3 rounded-md transition-colors ${state.activeTab === item.id ? 'bg-blue-600 text-white' : 'hover:bg-gray-700'}">
                <i data-lucide="${item.icon}" class="h-5 w-5 mr-3"></i>
                <span>${item.name}</span>
            </a>
        `).join('');
        lucide.createIcons();
    }
    
    async function renderActiveTab() {
        showView('loader-view');
        try {
            switch(state.activeTab) {
                case 'snapshot':
                    const { metadata } = await fetchCompanyPage(state.currentSymbol);
                    renderSnapshot(metadata);
                    break;
                case 'financials':
                    const { financials } = await fetchCompanyPage(state.currentSymbol);
                    renderFinancials(financials);
                    break;
                case 'historical':
                    const historicalData = await fetchHistoricalData(state.currentSymbol);
                    renderHistorical(historicalData);
                    break;
                case 'intraday':
                    const intradayData = await fetchIntradayData(state.currentSymbol);
                    renderIntraday(intradayData);
                    break;
                case 'announcements':
                    const announcementsData = await fetchAnnouncements(state.currentSymbol);
                    renderAnnouncements(announcementsData);
                    break;
                case 'comparison':
                    renderComparison();
                    break;
            }
            showView('data-views-container');
        } catch (error) {
            console.error(error);
            dataViewsContainer.innerHTML = `<div class="bg-gray-800 p-8 rounded-lg text-center">
                <i data-lucide="WifiOff" class="h-12 w-12 text-red-500 mx-auto mb-4"></i>
                <h3 class="text-xl font-semibold text-white">Data Fetch Failed</h3>
                <p class="text-gray-400 mt-2">Could not load data for ${state.currentSymbol}. The PSX server might be unavailable or the symbol is invalid. Please try again later.</p>
            </div>`;
            lucide.createIcons();
            showView('data-views-container');
        }
    }
    
    function createCard(title, value, changeValue = '', changePercent = '') {
        const isPositive = !changeValue.includes('-');
        const changeColor = changeValue ? (isPositive ? 'text-green-400' : 'text-red-400') : 'text-gray-400';
        return `
            <div class="bg-gray-800 p-4 rounded-lg">
                <p class="text-sm text-gray-400">${title}</p>
                <p class="text-2xl font-bold text-white">${value}</p>
                ${changeValue ? `<p class="text-sm ${changeColor}">${changeValue} (${changePercent})</p>` : ''}
            </div>
        `;
    }
    
    function renderSnapshot(data) {
        const profileHtml = Object.entries(data.profile).map(([key, value]) => `
            <div class="flex justify-between py-2 border-b border-gray-700">
                <span class="text-gray-400 capitalize">${key.replace(/_/g, ' ')}</span>
                <span class="text-white font-medium text-right">${value}</span>
            </div>
        `).join('');
        
        const peopleHtml = data.key_people.map(p => `
            <div class="flex justify-between py-2 border-b border-gray-700">
                <span class="text-gray-400">${p.role}</span>
                <span class="text-white font-medium">${p.name}</span>
            </div>
        `).join('');

        dataViewsContainer.innerHTML = `
            <div class="space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-white">${data.company_name} (${state.currentSymbol})</h2>
                        <p class="text-gray-400">${data.sector}</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    ${createCard('Last Close', data.last_close, data.change_value, data.change_percent)}
                    ${createCard('Day Range', data.day_range)}
                    ${createCard('52-Week Range', data.week_range_52)}
                    ${createCard('Market Cap', data.market_cap)}
                    ${createCard('Free Float (Shares)', data.free_float)}
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-gray-800 p-6 rounded-lg">
                        <h3 class="text-xl font-semibold text-white mb-4">Business Description</h3>
                        <p class="text-gray-300 leading-relaxed">${data.description}</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <h3 class="text-xl font-semibold text-white mb-4">Company Profile</h3>
                        <div class="space-y-2">${profileHtml}</div>
                    </div>
                </div>
                
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold text-white mb-4">Key People</h3>
                    <div class="space-y-2">${peopleHtml}</div>
                </div>
            </div>
        `;
    }
    
    function renderFinancials(data) {
        const createTable = (title, tableData) => {
            if (!tableData || tableData.rows.length === 0) {
                return `<div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold text-white mb-4">${title}</h3>
                    <p class="text-gray-400">Data not available.</p>
                </div>`;
            }
            return `
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold text-white mb-4">${title}</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="p-2">Metric</th>
                                    ${tableData.headers.map(h => `<th class="p-2 text-right">${h}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${tableData.rows.map(row => `
                                    <tr class="border-b border-gray-600">
                                        <td class="p-2 font-medium">${row.label}</td>
                                        ${row.values.map(v => `<td class="p-2 text-right">${formatNumber(v)}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        dataViewsContainer.innerHTML = `
            <div class="space-y-6">
                ${createTable('Financial Ratios', data.ratios)}
                ${createTable('Annual Financials', data.annual)}
                ${createTable('Quarterly Financials', data.quarterly)}
            </div>
        `;
    }

    function renderHistorical(data) {
        dataViewsContainer.innerHTML = `<div class="space-y-6">
            <div class="bg-gray-800 p-6 rounded-lg"><canvas id="priceChart"></canvas></div>
            <div class="bg-gray-800 p-6 rounded-lg"><canvas id="volumeChart"></canvas></div>
            <div class="bg-gray-800 p-6 rounded-lg"><canvas id="maChart"></canvas></div>
        </div>`;
        
        const labels = data.map(d => new Date(d.date).getTime());
        const closePrices = data.map(d => d.close);
        const volumes = data.map(d => d.volume);

        const calculateMA = (data, window) => {
            let result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < window -1) {
                    result.push(null);
                } else {
                    let sum = 0;
                    for (let j = 0; j < window; j++) {
                        sum += data[i - j];
                    }
                    result.push(sum / window);
                }
            }
            return result;
        };

        const ma50 = calculateMA(closePrices, 50);
        const ma200 = calculateMA(closePrices, 200);

        const chartOptions = {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { type: 'time', time: { unit: 'month' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                y: { grid: { color: 'rgba(255, 255, 255, 0.1)' } }
            },
            plugins: { legend: { labels: { color: '#d1d5db' } } }
        };

        new Chart('priceChart', {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: `${state.currentSymbol} Closing Price`,
                    data: closePrices,
                    borderColor: '#3b82f6',
                    tension: 0.1,
                    pointRadius: 0
                }]
            },
            options: { ...chartOptions, plugins: {...chartOptions.plugins, title: { display: true, text: 'Closing Price', color: 'white'}}}
        });

        new Chart('volumeChart', {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Volume',
                    data: volumes,
                    backgroundColor: 'rgba(59, 130, 246, 0.5)'
                }]
            },
            options: { ...chartOptions, plugins: {...chartOptions.plugins, title: { display: true, text: 'Volume Traded', color: 'white'}}}
        });

        new Chart('maChart', {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: 'Closing Price', data: closePrices, borderColor: '#3b82f6', pointRadius: 0 },
                    { label: '50-Day MA', data: ma50, borderColor: '#f97316', pointRadius: 0, borderDash: [5, 5] },
                    { label: '200-Day MA', data: ma200, borderColor: '#ef4444', pointRadius: 0, borderDash: [5, 5] }
                ]
            },
            options: { ...chartOptions, plugins: {...chartOptions.plugins, title: { display: true, text: 'Moving Averages', color: 'white'}}}
        });
    }

    function renderIntraday(data) {
        if (!data || data.length === 0) {
            dataViewsContainer.innerHTML = `<div class="bg-gray-800 p-6 rounded-lg text-center"><p>No intraday data available for ${state.currentSymbol}.</p></div>`;
            return;
        }

        const processedData = data.map(d => ({
            time: d.time * 1000,
            price: d.price,
            volume: d.volume
        })).sort((a,b) => a.time - b.time);

        let cumulativeVolume = 0;
        let cumulativePV = 0;
        const vwapData = processedData.map(d => {
            cumulativeVolume += d.volume;
            cumulativePV += d.price * d.volume;
            return cumulativeVolume > 0 ? cumulativePV / cumulativeVolume : d.price;
        });

        dataViewsContainer.innerHTML = `<div class="bg-gray-800 p-6 rounded-lg"><canvas id="intradayChart"></canvas></div>`;

        new Chart('intradayChart', {
            type: 'line',
            data: {
                labels: processedData.map(d => d.time),
                datasets: [
                    { label: 'Price', data: processedData.map(d => d.price), yAxisID: 'y', borderColor: '#3b82f6', pointRadius: 0},
                    { label: 'VWAP', data: vwapData, yAxisID: 'y', borderColor: '#f97316', pointRadius: 0, borderDash: [5,5] },
                    { label: 'Volume', data: processedData.map(d => d.volume), yAxisID: 'y1', type: 'bar', backgroundColor: 'rgba(255, 255, 255, 0.2)'}
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'time', time: { unit: 'minute' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                    y: { type: 'linear', position: 'left', grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: {color: '#3b82f6'}},
                    y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, ticks: {color: 'rgba(255,255,255,0.5)'} }
                },
                plugins: { legend: { labels: { color: '#d1d5db' } }, title: { display: true, text: 'Intraday Price, VWAP & Volume', color: 'white'} }
            }
        });
    }

    function renderAnnouncements(data) {
        const announcementsHtml = data.length > 0 ? data.map(item => `
            <div class="py-3 border-b border-gray-700">
                <div class="flex justify-between items-center">
                    <h4 class="font-semibold text-white">${item.title}</h4>
                    ${item.link ? `<a href="${item.link}" target="_blank" class="text-blue-400 hover:text-blue-300 transition-colors">View PDF</a>` : ''}
                </div>
                <p class="text-sm text-gray-400">${item.date} at ${item.time}</p>
            </div>
        `).join('') : '<p class="text-gray-400">No recent announcements found.</p>';
        
        dataViewsContainer.innerHTML = `<div class="bg-gray-800 p-6 rounded-lg">
            <h3 class="text-xl font-semibold text-white mb-4">Latest Announcements</h3>
            <div class="space-y-2">${announcementsHtml}</div>
        </div>`;
    }

    function renderComparison() {
        const { tickers } = state.comparison;
        dataViewsContainer.innerHTML = `
            <div class="space-y-6">
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold text-white mb-4">Select Companies to Compare</h3>
                    <div class="flex items-center gap-4 mb-4">
                        <div class="relative flex-grow" id="compare-search-container">
                            <input type="text" id="compareSearchInput" placeholder="Add up to ${state.comparison.max} companies..." class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                             <div id="compareSearchDropdown" class="search-dropdown-content mt-1 rounded-md shadow-lg"></div>
                        </div>
                        <button id="run-comparison-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Compare</button>
                    </div>
                    <div id="selected-tickers-list" class="flex flex-wrap gap-2">
                        ${tickers.map(ticker => `
                            <span class="flex items-center bg-gray-700 text-sm rounded-full px-3 py-1">
                                ${ticker}
                                <button data-ticker="${ticker}" class="remove-ticker-btn ml-2 text-gray-400 hover:text-white">&times;</button>
                            </span>
                        `).join('')}
                    </div>
                </div>
                <div id="comparison-results" class="space-y-6"></div>
            </div>`;

        // Setup searchable dropdown for comparison
        const compareInput = document.getElementById('compareSearchInput');
        const compareDropdown = document.getElementById('compareSearchDropdown');
        populateSearchDropdown(compareDropdown, (symbol) => {
            if (tickers.length < state.comparison.max && !tickers.includes(symbol)) {
                tickers.push(symbol);
                renderComparison(); // Re-render to show added ticker
            }
            compareInput.value = '';
            compareDropdown.style.display = 'none';
        });
        
        compareInput.addEventListener('keyup', () => filterFunction(compareInput, compareDropdown));
        document.getElementById('compare-search-container').addEventListener('focusin', () => compareDropdown.style.display = 'block');
        document.getElementById('compare-search-container').addEventListener('focusout', (e) => {
            if (!e.currentTarget.contains(e.relatedTarget)) {
                compareDropdown.style.display = 'none';
            }
        });
        
        // Add event listeners for remove and run buttons
        document.querySelectorAll('.remove-ticker-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tickerToRemove = e.target.dataset.ticker;
                state.comparison.tickers = state.comparison.tickers.filter(t => t !== tickerToRemove);
                renderComparison();
            });
        });

        document.getElementById('run-comparison-btn').addEventListener('click', runComparison);
    }
    
    async function runComparison() {
        const resultsContainer = document.getElementById('comparison-results');
        resultsContainer.innerHTML = `<div class="flex items-center justify-center p-8"><div class="loader"></div><p class="ml-4">Comparing tickers...</p></div>`;
        
        const { tickers } = state.comparison;
        if (tickers.length < 2) {
            resultsContainer.innerHTML = `<p class="text-yellow-400 text-center">Please select at least two companies to compare.</p>`;
            return;
        }

        try {
            const dataPromises = tickers.map(ticker => fetchHistoricalData(ticker));
            const allData = await Promise.all(dataPromises);

            // Normalize data by start date
            const priceData = {};
            allData.forEach((data, index) => {
                const ticker = tickers[index];
                const startPrice = data[0]?.close;
                if (!startPrice) return;
                priceData[ticker] = data.map(d => ({
                    x: new Date(d.date).getTime(),
                    y: (d.close / startPrice - 1) * 100 // Normalized percentage change
                }));
            });

            resultsContainer.innerHTML = `<div class="bg-gray-800 p-6 rounded-lg"><canvas id="comparisonChart"></canvas></div>`;
            
            const colors = ['#3b82f6', '#10b981', '#f97316', '#8b5cf6'];
            const datasets = Object.keys(priceData).map((ticker, i) => ({
                label: `${ticker} % Change`,
                data: priceData[ticker],
                borderColor: colors[i % colors.length],
                tension: 0.1,
                pointRadius: 0
            }));

            new Chart('comparisonChart', {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'month' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        y: { title: { display: true, text: 'Price Change (%)'}, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                    },
                    plugins: { 
                        legend: { labels: { color: '#d1d5db' } },
                        title: { display: true, text: 'Normalized Stock Performance', color: 'white' },
                        tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${context.raw.y.toFixed(2)}%` } }
                    }
                }
            });

        } catch (error) {
            console.error("Comparison failed:", error);
            resultsContainer.innerHTML = `<p class="text-red-500 text-center">Failed to fetch data for comparison. Please try again.</p>`;
        }
    }


    // --- EVENT HANDLING & INITIALIZATION ---
    
    function populateSearchDropdown(dropdownElement, onSelect) {
        const sortedSymbols = Object.keys(SYMBOLS).sort();
        let content = '';
        for (const symbol of sortedSymbols) {
            content += `<a href="#" data-symbol="${symbol}">${symbol} - ${SYMBOLS[symbol]}</a>`;
        }
        dropdownElement.innerHTML = content;
        
        dropdownElement.addEventListener('click', (e) => {
            e.preventDefault();
            const symbol = e.target.dataset.symbol;
            if (symbol) {
                onSelect(symbol);
            }
        });
    }

    function filterFunction(input = searchInput, dropdown = searchDropdown) {
        const filter = input.value.toUpperCase();
        const links = dropdown.getElementsByTagName('a');
        for (let i = 0; i < links.length; i++) {
            const txtValue = links[i].textContent || links[i].innerText;
            links[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? "" : "none";
        }
    }

    function selectSymbol(symbol) {
        state.currentSymbol = symbol;
        state.activeTab = 'snapshot';
        searchInput.value = `${symbol} - ${SYMBOLS[symbol]}`;
        searchDropdown.style.display = 'none';
        
        document.getElementById('navigation').classList.remove('hidden');
        renderNavigation();
        renderActiveTab();
    }
    
    function init() {
        populateSearchDropdown(searchDropdown, selectSymbol);
        
        // Handle search dropdown visibility
        searchContainer.addEventListener('focusin', () => searchDropdown.style.display = 'block');
        searchContainer.addEventListener('focusout', (e) => {
            // Hide only if focus moves outside the container
            if (!searchContainer.contains(e.relatedTarget)) {
                searchDropdown.style.display = 'none';
            }
        });
        
        // Handle nav clicks
        navigation.addEventListener('click', (e) => {
            const navItem = e.target.closest('.nav-item');
            if (navItem) {
                e.preventDefault();
                state.activeTab = navItem.dataset.tab;
                renderNavigation();
                if(state.currentSymbol || state.activeTab === 'comparison') {
                    renderActiveTab();
                }
            }
        });

        lucide.createIcons();
    }
    
    document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>

